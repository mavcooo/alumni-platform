// Prisma Schema for Alumni Platform
// PostgreSQL Database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  student
  alumni
  admin
  moderator
}

enum SectorType {
  informatica
  grafica
  acconciatura
  estetica
}

enum ContractType {
  stage
  tirocinio
  apprendistato
  tempo_determinato
  tempo_indeterminato
  freelance
}

enum OpportunityStatus {
  draft
  published
  closed
  archived
}

enum ApplicationStatus {
  pending
  reviewed
  accepted
  rejected
  withdrawn
}

enum MentorshipStatus {
  pending
  accepted
  rejected
  active
  completed
  cancelled
}

enum SessionStatus {
  scheduled
  completed
  cancelled
  no_show
}

enum EventType {
  workshop
  masterclass
  webinar
  networking
  visita_aziendale
}

enum NotificationType {
  message
  opportunity
  mentorship
  event
  forum
  endorsement
  system
}

enum PrivacyLevel {
  public
  alumni_only
  private
}

// Core User Tables
model User {
  id                String    @id @default(uuid())
  email             String    @unique
  passwordHash      String    @map("password_hash")
  role              UserRole
  emailVerified     Boolean   @default(false) @map("email_verified")
  twoFactorEnabled  Boolean   @default(false) @map("two_factor_enabled")
  twoFactorSecret   String?   @map("two_factor_secret")
  lastLogin         DateTime? @map("last_login")
  isActive          Boolean   @default(true) @map("is_active")
  deletedAt         DateTime? @map("deleted_at")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  profile              Profile?
  messages             Message[]
  forumPosts           ForumPost[]
  forumVotes           ForumVote[]
  eventRegistrations   EventRegistration[]
  notifications        Notification[]
  createdEvents        Event[]
  auditLogs            AuditLog[]
  consentLogs          ConsentLog[]
  dataDeletionRequests DataDeletionRequest[]
  activityLogs         UserActivityLog[]
  conversationsAsP1    Conversation[]       @relation("participant1")
  conversationsAsP2    Conversation[]       @relation("participant2")

  @@index([email])
  @@index([role])
  @@index([isActive])
  @@map("users")
}

model Profile {
  id              String      @id @default(uuid())
  userId          String      @unique @map("user_id")
  firstName       String      @map("first_name")
  lastName        String      @map("last_name")
  avatarUrl       String?     @map("avatar_url")
  bio             String?
  phone           String?
  city            String?
  province        String?
  linkedinUrl     String?     @map("linkedin_url")
  portfolioUrl    String?     @map("portfolio_url")
  sector          SectorType
  graduationYear  Int?        @map("graduation_year")
  privacySettings Json        @default("{\"profile_visibility\": \"alumni_only\", \"email_visible\": false, \"phone_visible\": false}") @map("privacy_settings")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  user               User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  studentProfile     StudentProfile?
  alumniProfile      AlumniProfile?
  skills             ProfileSkill[]
  endorsementsGiven  Endorsement[]       @relation("endorser")
  endorsementsReceived Endorsement[]     @relation("endorsed")
  portfolio          Portfolio?

  @@index([userId])
  @@index([sector])
  @@index([graduationYear])
  @@map("profiles")
}

model StudentProfile {
  id                     String   @id @default(uuid())
  profileId              String   @unique @map("profile_id")
  currentYear            Int      @map("current_year")
  expectedGraduationYear Int      @map("expected_graduation_year")
  interests              String[]
  lookingForMentorship   Boolean  @default(true) @map("looking_for_mentorship")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  profile             Profile               @relation(fields: [profileId], references: [id], onDelete: Cascade)
  applications        Application[]
  mentorshipRequests  MentorshipRequest[]

  @@index([profileId])
  @@index([lookingForMentorship])
  @@map("student_profiles")
}

model AlumniProfile {
  id                     String   @id @default(uuid())
  profileId              String   @unique @map("profile_id")
  currentPosition        String?  @map("current_position")
  currentCompany         String?  @map("current_company")
  yearsExperience        Int?     @map("years_experience")
  specializations        String[]
  availableForMentorship Boolean  @default(false) @map("available_for_mentorship")
  mentorshipCapacity     Int      @default(3) @map("mentorship_capacity")
  expertiseAreas         String[] @map("expertise_areas")
  verified               Boolean  @default(false)
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  profile            Profile               @relation(fields: [profileId], references: [id], onDelete: Cascade)
  opportunities      Opportunity[]
  mentorshipRequests MentorshipRequest[]

  @@index([profileId])
  @@index([availableForMentorship])
  @@index([verified])
  @@map("alumni_profiles")
}

// Skills System
model Skill {
  id        String      @id @default(uuid())
  name      String      @unique
  sector    SectorType?
  createdAt DateTime    @default(now()) @map("created_at")

  profileSkills ProfileSkill[]
  endorsements  Endorsement[]

  @@map("skills")
}

model ProfileSkill {
  id               String   @id @default(uuid())
  profileId        String   @map("profile_id")
  skillId          String   @map("skill_id")
  proficiencyLevel Int?     @map("proficiency_level")
  createdAt        DateTime @default(now()) @map("created_at")

  profile Profile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  skill   Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([profileId, skillId])
  @@map("profile_skills")
}

model Endorsement {
  id                 String   @id @default(uuid())
  endorserProfileId  String   @map("endorser_profile_id")
  endorsedProfileId  String   @map("endorsed_profile_id")
  skillId            String   @map("skill_id")
  comment            String?
  createdAt          DateTime @default(now()) @map("created_at")

  endorser Profile @relation("endorser", fields: [endorserProfileId], references: [id], onDelete: Cascade)
  endorsed Profile @relation("endorsed", fields: [endorsedProfileId], references: [id], onDelete: Cascade)
  skill    Skill   @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@unique([endorserProfileId, endorsedProfileId, skillId])
  @@map("endorsements")
}

// Opportunities
model Opportunity {
  id                  String            @id @default(uuid())
  postedByAlumniId    String            @map("posted_by_alumni_id")
  title               String
  description         String
  companyName         String            @map("company_name")
  location            String?
  contractType        ContractType      @map("contract_type")
  sector              SectorType
  requiredSkills      String[]          @map("required_skills")
  salaryRange         String?           @map("salary_range")
  applicationDeadline DateTime?         @map("application_deadline")
  status              OpportunityStatus @default(draft)
  viewsCount          Int               @default(0) @map("views_count")
  applicationsCount   Int               @default(0) @map("applications_count")
  externalUrl         String?           @map("external_url")
  deletedAt           DateTime?         @map("deleted_at")
  createdAt           DateTime          @default(now()) @map("created_at")
  updatedAt           DateTime          @updatedAt @map("updated_at")

  postedBy     AlumniProfile @relation(fields: [postedByAlumniId], references: [id], onDelete: Cascade)
  applications Application[]

  @@index([postedByAlumniId])
  @@index([sector])
  @@index([status])
  @@index([contractType])
  @@map("opportunities")
}

model Application {
  id               String            @id @default(uuid())
  opportunityId    String            @map("opportunity_id")
  studentProfileId String            @map("student_profile_id")
  coverLetter      String?           @map("cover_letter")
  cvUrl            String?           @map("cv_url")
  status           ApplicationStatus @default(pending)
  notes            String?
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  opportunity    Opportunity    @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  studentProfile StudentProfile @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)

  @@unique([opportunityId, studentProfileId])
  @@index([opportunityId])
  @@index([studentProfileId])
  @@index([status])
  @@map("applications")
}

// Mentorship
model MentorshipRequest {
  id               String            @id @default(uuid())
  studentProfileId String            @map("student_profile_id")
  alumniProfileId  String            @map("alumni_profile_id")
  message          String
  status           MentorshipStatus  @default(pending)
  responseMessage  String?           @map("response_message")
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  studentProfile StudentProfile      @relation(fields: [studentProfileId], references: [id], onDelete: Cascade)
  alumniProfile  AlumniProfile       @relation(fields: [alumniProfileId], references: [id], onDelete: Cascade)
  sessions       MentorshipSession[]

  @@index([studentProfileId])
  @@index([alumniProfileId])
  @@index([status])
  @@map("mentorship_requests")
}

model MentorshipSession {
  id                   String         @id @default(uuid())
  mentorshipRequestId  String         @map("mentorship_request_id")
  scheduledAt          DateTime       @map("scheduled_at")
  durationMinutes      Int            @default(60) @map("duration_minutes")
  meetingUrl           String?        @map("meeting_url")
  meetingNotes         String?        @map("meeting_notes")
  status               SessionStatus  @default(scheduled)
  studentFeedback      String?        @map("student_feedback")
  alumniFeedback       String?        @map("alumni_feedback")
  studentRating        Int?           @map("student_rating")
  alumniRating         Int?           @map("alumni_rating")
  createdAt            DateTime       @default(now()) @map("created_at")
  updatedAt            DateTime       @updatedAt @map("updated_at")

  mentorshipRequest MentorshipRequest @relation(fields: [mentorshipRequestId], references: [id], onDelete: Cascade)

  @@map("mentorship_sessions")
}

// Messaging
model Conversation {
  id              String    @id @default(uuid())
  participant1Id  String    @map("participant1_id")
  participant2Id  String    @map("participant2_id")
  lastMessageAt   DateTime? @map("last_message_at")
  createdAt       DateTime  @default(now()) @map("created_at")

  participant1 User      @relation("participant1", fields: [participant1Id], references: [id], onDelete: Cascade)
  participant2 User      @relation("participant2", fields: [participant2Id], references: [id], onDelete: Cascade)
  messages     Message[]

  @@unique([participant1Id, participant2Id])
  @@map("conversations")
}

model Message {
  id                 String    @id @default(uuid())
  conversationId     String    @map("conversation_id")
  senderId           String    @map("sender_id")
  content            String
  readAt             DateTime? @map("read_at")
  deletedBySender    Boolean   @default(false) @map("deleted_by_sender")
  deletedByReceiver  Boolean   @default(false) @map("deleted_by_receiver")
  createdAt          DateTime  @default(now()) @map("created_at")

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender       User         @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([senderId])
  @@map("messages")
}

// Events
model Event {
  id                  String      @id @default(uuid())
  createdByUserId     String      @map("created_by_user_id")
  title               String
  description         String
  eventType           EventType   @map("event_type")
  sector              SectorType?
  startDatetime       DateTime    @map("start_datetime")
  endDatetime         DateTime    @map("end_datetime")
  location            String?
  isOnline            Boolean     @default(false) @map("is_online")
  meetingUrl          String?     @map("meeting_url")
  maxParticipants     Int?        @map("max_participants")
  currentParticipants Int         @default(0) @map("current_participants")
  coverImageUrl       String?     @map("cover_image_url")
  materialsUrl        String?     @map("materials_url")
  recordingUrl        String?     @map("recording_url")
  isPublished         Boolean     @default(false) @map("is_published")
  deletedAt           DateTime?   @map("deleted_at")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")

  createdBy      User                @relation(fields: [createdByUserId], references: [id], onDelete: Cascade)
  registrations  EventRegistration[]

  @@index([startDatetime])
  @@index([sector])
  @@index([eventType])
  @@index([isPublished])
  @@map("events")
}

model EventRegistration {
  id        String    @id @default(uuid())
  eventId   String    @map("event_id")
  userId    String    @map("user_id")
  attended  Boolean   @default(false)
  feedback  String?
  rating    Int?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_registrations")
}

// Forum
model ForumCategory {
  id          String      @id @default(uuid())
  name        String
  description String?
  sector      SectorType?
  icon        String?
  sortOrder   Int         @default(0) @map("sort_order")
  createdAt   DateTime    @default(now()) @map("created_at")

  posts ForumPost[]

  @@map("forum_categories")
}

model ForumPost {
  id           String    @id @default(uuid())
  categoryId   String    @map("category_id")
  authorId     String    @map("author_id")
  parentPostId String?   @map("parent_post_id")
  title        String?
  content      String
  tags         String[]
  upvotesCount Int       @default(0) @map("upvotes_count")
  viewsCount   Int       @default(0) @map("views_count")
  isPinned     Boolean   @default(false) @map("is_pinned")
  isLocked     Boolean   @default(false) @map("is_locked")
  deletedAt    DateTime? @map("deleted_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  category   ForumCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  author     User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parentPost ForumPost?    @relation("PostReplies", fields: [parentPostId], references: [id], onDelete: Cascade)
  replies    ForumPost[]   @relation("PostReplies")
  votes      ForumVote[]

  @@index([categoryId])
  @@index([authorId])
  @@index([parentPostId])
  @@map("forum_posts")
}

model ForumVote {
  id        String   @id @default(uuid())
  postId    String   @map("post_id")
  userId    String   @map("user_id")
  voteValue Int      @map("vote_value")
  createdAt DateTime @default(now()) @map("created_at")

  post ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([postId, userId])
  @@map("forum_votes")
}

// Portfolio
model Portfolio {
  id          String   @id @default(uuid())
  profileId   String   @unique @map("profile_id")
  title       String?
  description String?
  isPublic    Boolean  @default(true) @map("is_public")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  profile Profile         @relation(fields: [profileId], references: [id], onDelete: Cascade)
  items   PortfolioItem[]

  @@map("portfolios")
}

model PortfolioItem {
  id           String   @id @default(uuid())
  portfolioId  String   @map("portfolio_id")
  title        String
  description  String?
  itemType     String   @map("item_type")
  mediaUrl     String?  @map("media_url")
  thumbnailUrl String?  @map("thumbnail_url")
  externalUrl  String?  @map("external_url")
  tags         String[]
  sortOrder    Int      @default(0) @map("sort_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  portfolio Portfolio @relation(fields: [portfolioId], references: [id], onDelete: Cascade)

  @@map("portfolio_items")
}

// Notifications
model Notification {
  id                String           @id @default(uuid())
  userId            String           @map("user_id")
  type              NotificationType
  title             String
  content           String
  relatedEntityType String?          @map("related_entity_type")
  relatedEntityId   String?          @map("related_entity_id")
  actionUrl         String?          @map("action_url")
  readAt            DateTime?        @map("read_at")
  createdAt         DateTime         @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([type])
  @@map("notifications")
}

// Security & Audit
model AuditLog {
  id         String    @id @default(uuid())
  userId     String?   @map("user_id")
  action     String
  entityType String    @map("entity_type")
  entityId   String?   @map("entity_id")
  oldValues  Json?     @map("old_values")
  newValues  Json?     @map("new_values")
  ipAddress  String?   @map("ip_address")
  userAgent  String?   @map("user_agent")
  createdAt  DateTime  @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

model ConsentLog {
  id           String   @id @default(uuid())
  userId       String   @map("user_id")
  consentType  String   @map("consent_type")
  consentGiven Boolean  @map("consent_given")
  consentText  String?  @map("consent_text")
  ipAddress    String?  @map("ip_address")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("consent_logs")
}

model DataDeletionRequest {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  reason      String?
  status      String    @default("pending")
  processedAt DateTime? @map("processed_at")
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("data_deletion_requests")
}

// Analytics
model UserActivityLog {
  id               String   @id @default(uuid())
  userId           String?  @map("user_id")
  sessionId        String   @map("session_id")
  pageUrl          String   @map("page_url")
  actionType       String?  @map("action_type")
  actionDetails    Json?    @map("action_details")
  timeSpentSeconds Int?     @map("time_spent_seconds")
  referrerUrl      String?  @map("referrer_url")
  deviceType       String?  @map("device_type")
  browser          String?
  createdAt        DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId, createdAt])
  @@index([sessionId])
  @@map("user_activity_logs")
}
